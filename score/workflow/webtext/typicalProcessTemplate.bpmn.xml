<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://activiti.org/bpmn20" id="review-definitions">
  <process id="documentApprovingProcess" name="Утверждение документа" isExecutable="true">
    <startEvent id="startevent1" name="Start"></startEvent>
    <userTask id="createDocument" name="Создание документа" activiti:assignee="${initiator}" activiti:formKey="workWithDocument">
		<extensionElements>
        <activiti:taskListener event="create" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:expression>docVersion = task.setVariable("documentVersion", "ed000")
			</activiti:expression>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="create" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:expression>task.setVariable("docEditable", "true")</activiti:expression>
          </activiti:field>
        </activiti:taskListener>
		 <activiti:taskListener event="create" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:expression>task.setVariable("processStatus", "underConstruction")</activiti:expression>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:expression>task.setVariable("docEditable", "false")
								deleteDocument = task.getVariable("deleteDocument")
if (deleteDocument == "false"){	
	task.setVariable("processStatus","onAgreement")
	task.setVariable("documentVersion","ed011")
}
if (deleteDocument == "true"){	
	task.setVariable("processStatus","rejected")
	task.setVariable("documentVersion","ed010")
}</activiti:expression>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <sequenceFlow id="fromStartToCreate" sourceRef="startevent1" targetRef="createDocument"></sequenceFlow>
    <exclusiveGateway id="deleteDocumentExclusivegateway" name="Exclusive Gateway"></exclusiveGateway>
    <sequenceFlow id="fromStartToDeleteGateway" sourceRef="createDocument" targetRef="deleteDocumentExclusivegateway"></sequenceFlow>
    <endEvent id="endevent1" name="End"></endEvent>
    <sequenceFlow id="fromDeleteToEnd1" sourceRef="deleteDocumentExclusivegateway" targetRef="endevent1">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${deleteDocument == "true"}]]></conditionExpression>
    </sequenceFlow>
	
	<userTask id="reworkDocument" name="Доработка документа" activiti:assignee="${initiator}" activiti:formKey="workWithDocument">
		<extensionElements>
		 <activiti:taskListener event="create" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:expression>task.setVariable("processStatus", "refinement")</activiti:expression>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.activiti.engine.impl.bpmn.listener.ScriptTaskListener">
          <activiti:field name="language">
            <activiti:string><![CDATA[groovy]]></activiti:string>
          </activiti:field>
          <activiti:field name="script">
            <activiti:expression>
import java.util.regex.Matcher
import java.util.regex.Pattern

maxNumberLength = 3
taskKey = "ed"
docVersion = task.getVariable("documentVersion")
pattern = "^" + taskKey + "[0-9]{3}|(?&lt;=[0-9])" + taskKey + "[0-9]{3}"
mtchr = docVersion =~ pattern
if (mtchr.size() &lt;= 0) {
       strNum = "000"
 docVersion+=taskKey+strNum
} else {
       strNum = mtchr[0][taskKey.length()..taskKey.length()+maxNumberLength-1]
}
num = strNum.toInteger()
newNum=num+10
deleteDocument = task.getVariable("deleteDocument")
if (deleteDocument == "false"){	
	task.setVariable("processStatus","onAgreement")
	newNum=newNum.intdiv(10)*10+1
}
if (deleteDocument == "true"){
	newNum=newNum.intdiv(10)*10
	task.setVariable("processStatus","rejected")
}
for (i=1; i&lt;=maxNumberLength; i++){
       if (newNum.intdiv(10**i)==0){
  strNewNum="0"*(maxNumberLength-i)+newNum.toString()
              break
       }
}
docVersion = docVersion.replaceAll(taskKey+strNum, taskKey+strNewNum)

task.setVariable("documentVersion", docVersion)
</activiti:expression>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>	
	
	</userTask>
  
	<sequenceFlow id="fromReworkToDelete" sourceRef="reworkDocument" targetRef="deleteDocumentExclusivegateway"></sequenceFlow>
	
	<startDescriptionTasks>
	</startDescriptionTasks>
    


	<sequenceFlow id="finalFlow" sourceRef="finalApprovementExclusivegateway" targetRef="endevent2">
      
		      		 <extensionElements>
			<activiti:executionListener event="take" class="org.activiti.engine.impl.bpmn.listener.ScriptExecutionListener">
			  <activiti:field name="language">
				<activiti:string>groovy</activiti:string>
			  </activiti:field>
			  <activiti:field name="script">
				<activiti:expression>
query = execution.getEngineServices().getTaskService().createTaskQuery().processInstanceId(execution.getProcessInstanceId()).orderByTaskName().asc()
execution.setVariable("processStatus","agreed")
				</activiti:expression>
			  </activiti:field>
			</activiti:executionListener>
      </extensionElements> 
	  <conditionExpression xsi:type="tFormalExpression"><![CDATA[${orderApproved == "true"}]]></conditionExpression>
    </sequenceFlow>
	
	<endEvent id="endevent2" name="End"></endEvent>
	
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_documentApprovingProcess">
	<bpmndi:BPMNPlane bpmnElement="documentApprovingProcess" id="BPMNPlane_documentApprovingProcess">
		<diagramDescription> </diagramDescription>
	</bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>